<!doctype html>
<html lang="en-us">
  <head>
    <title>Create an internal load balancer in Azure Kubernetes Service (AKS) // Cloud architect insights :: Joshua Mangold</title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.92.2" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="John Doe" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="/mangoldaiwiki/css/main.min.d18c46a9c052e3fff4ff60ea22fff43c74140b8b952b4bbebd229127fbf997f3.css" />
    

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Create an internal load balancer in Azure Kubernetes Service (AKS)"/>
<meta name="twitter:description" content="As a cluster operator or developer, you may want to create a service in AKS that uses an internal Azure load balancer for enhanced security and without an external endpoint. This article shows you how to create and use an internal load balancer with AKS.
Before you begin  This article assumes that you have an existing AKS cluster. If you need an AKS cluster, you can create one using Azure CLI, Azure PowerShell, or the Azure portal."/>

    <meta property="og:title" content="Create an internal load balancer in Azure Kubernetes Service (AKS)" />
<meta property="og:description" content="As a cluster operator or developer, you may want to create a service in AKS that uses an internal Azure load balancer for enhanced security and without an external endpoint. This article shows you how to create and use an internal load balancer with AKS.
Before you begin  This article assumes that you have an existing AKS cluster. If you need an AKS cluster, you can create one using Azure CLI, Azure PowerShell, or the Azure portal." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://jmangold23.github.io/mangoldaiwiki/posts/create_an_internal_load_balancer_in_azure_kubernetes_service_aks.2023-09-17t220900-0500/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-17T22:09:00-05:00" />
<meta property="article:modified_time" content="2023-09-17T22:09:00-05:00" />



  </head>
  <body>
    <header class="app-header">
      <a href="https://jmangold23.github.io/mangoldaiwiki/"><img class="app-header-avatar" src="/mangoldaiwiki/avatar.jpg" alt="John Doe" /></a>
      <span class="app-header-title">Cloud architect insights :: Joshua Mangold</span>
      <nav class="app-header-menu">
          <a class="app-header-menu-item" href="/mangoldaiwiki/">Home</a>
             - 
          
          <a class="app-header-menu-item" href="/mangoldaiwiki/tags/">Tags</a>
      </nav>
      <p>Cloud architecture, Azure, and tech innovations. Notes, tips, and insights.</p>
      <div class="app-header-social">
        
          <a href="https://github.com/jmangold23" target="_blank" rel="noreferrer noopener me">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>My Github</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg>
          </a>
        
          <a href="https://www.linkedin.com/in/joshua-mangold-a7ba0989/" target="_blank" rel="noreferrer noopener me">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-linkedin">
  <title>My LinkedIn</title>
  <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle>
</svg>
          </a>
        
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Create an internal load balancer in Azure Kubernetes Service (AKS)</h1>
      <div class="post-meta">
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Sep 17, 2023
        </div>
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          5 min read
        </div>
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line>
</svg>
              <a class="tag" href="https://jmangold23.github.io/mangoldaiwiki/tags/tutorial/">tutorial</a>
              <a class="tag" href="https://jmangold23.github.io/mangoldaiwiki/tags/aks/">AKS</a>
        </div>
      </div>
    </header>
    <div class="post-content">
      <p>As a cluster operator or developer, you may want to create a service in AKS that uses an internal Azure load balancer for enhanced security and without an external endpoint. This article shows you how to create and use an internal load balancer with AKS.</p>
<h2 id="before-you-begin">Before you begin</h2>
<ul>
<li>This article assumes that you have an existing AKS cluster. If you need an AKS cluster, you can create one using Azure CLI, Azure PowerShell, or the Azure portal.</li>
<li>You need the Azure CLI version 2.0.59 or later.</li>
<li>If you want to use an existing subnet or resource group, the AKS cluster identity needs permission to manage network resources. For more information, see <a href="configure-kubenet.md">Use kubenet networking with your own IP address ranges in AKS</a> or <a href="configure-azure-cni.md">Configure Azure CNI networking in AKS</a>.</li>
</ul>
<h2 id="create-an-internal-load-balancer">Create an internal load balancer</h2>
<ol>
<li>Create a service manifest named <code>internal-lb.yaml</code> with the service type <code>LoadBalancer</code> and the <code>azure-load-balancer-internal</code> annotation.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">internal-app</span>
  <span style="color:#f92672">annotations</span>:
    <span style="color:#f92672">service.beta.kubernetes.io/azure-load-balancer-internal</span>: <span style="color:#e6db74">&#34;true&#34;</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">LoadBalancer</span>
  <span style="color:#f92672">ports</span>:
  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">internal-app</span>
</code></pre></div><ol start="2">
<li>Deploy the internal load balancer using the <code>kubectl apply</code> command.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl apply -f internal-lb.yaml
</code></pre></div><ol start="3">
<li>View the service details using the <code>kubectl get service</code> command.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl get service internal-app
</code></pre></div><p>The IP address of the internal load balancer is shown in the <code>EXTERNAL-IP</code> column.</p>
<h3 id="specify-an-ip-address">Specify an IP address</h3>
<p>When you specify an IP address for the load balancer, the specified IP address must reside in the same virtual network as the AKS cluster, but it can&rsquo;t already be assigned to another resource in the virtual network. You can use the <code>az network vnet subnet list</code> Azure CLI command or the <code>Get-AzVirtualNetworkSubnetConfig</code> PowerShell cmdlet to get the subnets in your virtual network.</p>
<p>You have two options for specifying an IP address:</p>
<ul>
<li>Set service annotations: Use <code>service.beta.kubernetes.io/azure-load-balancer-ipv4</code> for an IPv4 address and <code>service.beta.kubernetes.io/azure-load-balancer-ipv6</code> for an IPv6 address.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">internal-app</span>
  <span style="color:#f92672">annotations</span>:
    <span style="color:#f92672">service.beta.kubernetes.io/azure-load-balancer-ipv4</span>: <span style="color:#ae81ff">10.240.0.25</span>
    <span style="color:#f92672">service.beta.kubernetes.io/azure-load-balancer-internal</span>: <span style="color:#e6db74">&#34;true&#34;</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">LoadBalancer</span>
  <span style="color:#f92672">ports</span>:
  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">internal-app</span>
</code></pre></div><ul>
<li>Add the <code>LoadBalancerIP</code> property to the load balancer YAML manifest: This field is deprecated, and it can&rsquo;t support dual-stack.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">internal-app</span>
  <span style="color:#f92672">annotations</span>:
    <span style="color:#f92672">service.beta.kubernetes.io/azure-load-balancer-internal</span>: <span style="color:#e6db74">&#34;true&#34;</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">LoadBalancer</span>
  <span style="color:#f92672">loadBalancerIP</span>: <span style="color:#ae81ff">10.240.0.25</span>
  <span style="color:#f92672">ports</span>:
  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
  <span style="color:#f92672">selector</span>:
    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">internal-app</span>
</code></pre></div><h2 id="connect-azure-private-link-service-to-internal-load-balancer">Connect Azure Private Link service to internal load balancer</h2>
<p>You can use Azure Private Link service to connect to your Kubernetes service object via the internal load balancer. You need Kubernetes version 1.22.x or later and an existing resource group with a VNet and subnet.</p>
<ol>
<li>Create a Private Link service connection.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl apply -f internal-lb-pls.yaml
</code></pre></div><ol start="2">
<li>View the service details using the <code>kubectl get service</code> command.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl get service internal-app
</code></pre></div><ol start="3">
<li>View the details of the Private Link Service object using the <code>az network private-link-service list</code> command.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">AKS_MC_RG<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>az aks show -g myResourceGroup --name myAKSCluster --query nodeResourceGroup -o tsv<span style="color:#66d9ef">)</span>
az network private-link-service list -g $AKS_MC_RG --query <span style="color:#e6db74">&#34;[][].{Name:name,Alias:alias}&#34;</span> -o table
</code></pre></div><ol start="4">
<li>Create a Private Endpoint to the Private Link service.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">AKS_PLS_ID<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>az network private-link-service list -g $AKS_MC_RG --query <span style="color:#e6db74">&#34;[].id&#34;</span> -o tsv<span style="color:#66d9ef">)</span>
az network private-endpoint create -g myOtherResourceGroup --name myAKSServicePE --vnet-name myOtherVNET --subnet pe-subnet --private-connection-resource-id $AKS_PLS_ID --connection-name connectToMyK8sService
</code></pre></div><h2 id="pls-customizations-via-annotations">PLS Customizations via Annotations</h2>
<p>You can use annotations to customize the PLS resource.</p>
<table>
<thead>
<tr>
<th>Annotation</th>
<th>Value</th>
<th>Description</th>
<th>Required</th>
<th>Default</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>service.beta.kubernetes.io/azure-pls-create</code></td>
<td><code>&quot;true&quot;</code></td>
<td>Boolean indicating whether a PLS needs to be created.</td>
<td>Required</td>
<td></td>
</tr>
<tr>
<td><code>service.beta.kubernetes.io/azure-pls-name</code></td>
<td><code>&lt;PLS name&gt;</code></td>
<td>String specifying the name of the PLS resource to be created.</td>
<td>Optional</td>
<td><code>pls-&lt;LB frontend config name&gt;</code></td>
</tr>
<tr>
<td><code>service.beta.kubernetes.io/azure-pls-resource-group</code></td>
<td><code>Resource Group name</code></td>
<td>String specifying the name of the Resource Group where the PLS resource will be created</td>
<td>Optional</td>
<td><code>MC_ resource</code></td>
</tr>
<tr>
<td><code>service.beta.kubernetes.io/azure-pls-ip-configuration-subnet</code></td>
<td><code>&lt;Subnet name&gt;</code></td>
<td>String indicating the subnet to which the PLS will be deployed. This subnet must exist in the same VNET as the backend pool. PLS NAT IPs are allocated within this subnet.</td>
<td>Optional</td>
<td>If <code>service.beta.kubernetes.io/azure-load-balancer-internal-subnet</code>, this ILB subnet is used. Otherwise, the default subnet from config file is used.</td>
</tr>
<tr>
<td><code>service.beta.kubernetes.io/azure-pls-ip-configuration-ip-address-count</code></td>
<td><code>[1-8]</code></td>
<td>Total number of private NAT IPs to allocate.</td>
<td>Optional</td>
<td><code>1</code></td>
</tr>
<tr>
<td><code>service.beta.kubernetes.io/azure-pls-ip-configuration-ip-address</code></td>
<td><code>&quot;10.0.0.7 ... 10.0.0.10&quot;</code></td>
<td>A space separated list of static IPv4 IPs to be allocated. (IPv6 is not supported right now.) Total number of IPs should not be greater than the ip count specified in <code>service.beta.kubernetes.io/azure-pls-ip-configuration-ip-address-count</code>. If there are fewer IPs specified, the rest are dynamically allocated. The first IP in the list is set as <code>Primary</code>.</td>
<td>Optional</td>
<td>All IPs are dynamically allocated.</td>
</tr>
<tr>
<td><code>service.beta.kubernetes.io/azure-pls-fqdns</code></td>
<td><code>&quot;fqdn1 fqdn2&quot;</code></td>
<td>A space separated list of fqdns associated with the PLS.</td>
<td>Optional</td>
<td><code>[]</code></td>
</tr>
<tr>
<td><code>service.beta.kubernetes.io/azure-pls-proxy-protocol</code></td>
<td><code>&quot;true&quot;</code> or <code>&quot;false&quot;</code></td>
<td>Boolean indicating whether the TCP PROXY protocol should be enabled on the PLS to pass through connection information, including the link ID and source IP address. Note that the backend service MUST support the PROXY protocol or the connections will fail.</td>
<td>Optional</td>
<td><code>false</code></td>
</tr>
<tr>
<td><code>service.beta.kubernetes.io/azure-pls-visibility</code></td>
<td><code>&quot;sub1 sub2 sub3 \u2026 subN&quot;</code> or <code>&quot;*&quot;</code></td>
<td>A space separated list of Azure subscription ids for which the private link service is visible. Use <code>&quot;*&quot;</code> to expose the PLS to all subs (Least restrictive).</td>
<td>Optional</td>
<td>Empty list <code>[]</code> indicating role-based access control only: This private link service will only be available to individuals with role-based access control permissions within your directory. (Most restrictive)</td>
</tr>
<tr>
<td><code>service.beta.kubernetes.io/azure-pls-auto-approval</code></td>
<td><code>&quot;sub1 sub2 sub3 \u2026 subN&quot;</code></td>
<td>A space separated list of Azure subscription ids. This allows PE connection requests from the subscriptions listed to the PLS to be automatically approved. This only works when visibility is set to <code>&quot;*&quot;</code>.</td>
<td>Optional</td>
<td><code>[]</code></td>
</tr>
</tbody>
</table>
<h2 id="use-private-networks">Use private networks</h2>
<p>When you create your AKS cluster, you can specify advanced networking settings to deploy the cluster into an existing Azure virtual network and subnets. You don&rsquo;t need to make any changes to the previous steps to deploy an internal load balancer that uses a private network in an AKS cluster.</p>
<h2 id="delete-the-load-balancer">Delete the load balancer</h2>
<p>The load balancer is deleted when all of its services are deleted. You can directly delete a service, such as <code>kubectl delete service internal-app</code>, which also deletes the underlying Azure load balancer.</p>
<h2 id="next-steps">Next steps</h2>
<p>To learn more about Kubernetes services, see the <a href="https://kubernetes.io/docs/concepts/services-networking/service/">Kubernetes services documentation</a>.</p>

    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
